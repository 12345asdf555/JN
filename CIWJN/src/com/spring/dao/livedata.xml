<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.dao.LiveDataMapper">

	<resultMap id="liveMap" type="com.spring.model.LiveData">
		<id property="id" column="fid"></id> 
        <result property="electricity" column="felectricity"></result>  
        <result property="voltage" column="fvoltage"></result>  
        <result property="rateofflow" column="frateofflow"></result>
       	<result property="status" column="fstatus"></result>
       	<result property="uploadDateTime" column="fuploaddatetime"></result>
       	<result property="weldTime" column="weldtime"></result>
       	<result property="dyne" column="dynes"></result>
       	<result property="hous" column="hous"></result>
       	<result property="fid" column="fid"></result>
       	<result property="fname" column="fname"></result>
       	<result property="externalDiameter" column="fexternal_diameter"></result>
       	<result property="wallThickness" column="fwall_thickness"></result>
       	<result property="material" column="fmaterial"></result>
       	<result property="nextexternaldiameter" column="fnextExternal_diameter"></result>
       	<result property="itemid" column="itemid"></result>
       	<result property="overproof" column="overproof"></result>
       	<result property="jidgather" column="jidgather"></result>
       	<association property="machine" column="fmachine_id" javaType="com.spring.model.WeldingMachine">
       		<id property="id" column="mid"></id> 
			<result property="equipmentNo" column="fequipment_no" />		
			<result property="position" column="fposition" />
			<result property="isnetworking" column="fisnetworking" />
			<result property="joinTime" column="fjoin_time" />
			<result property="typeId" column="ftype_id" />
			<result property="statusId" column="fstatus_id" />
       	</association>
       	<association property="welder" column="fwelder_id" javaType="com.spring.model.Person">
       		<id property="id" column="wid"></id> 
	        <result property="welderno" column="fwelder_no"></result>  
	        <result property="name" column="fname"></result>
       	</association>
       	<association property="junction" column="fjunction_id" javaType="com.spring.model.WeldedJunction">
       		<id property="id" column="jid"></id> 
	        <result property="weldedJunctionno" column="fwelded_junction_no"></result>  
	        <result property="serialNo" column="fserial_no"></result>
	        <result property="pipelineNo" column="fpipeline_no"></result>
	        <result property="roomNo" column="froom_no"></result>
	        <result property="unit" column="funit"></result>
	        <result property="area" column="farea"></result>
	        <result property="systems" column="fsystems"></result>
	        <result property="children" column="fchildren"></result>
	        <result property="externalDiameter" column="fexternal_diameter"></result>
	        <result property="wallThickness" column="fwall_thickness"></result>
	        <result property="dyne" column="fdyne"></result>
	        <result property="specification" column="fspecification"></result>
	        <result property="maxElectricity" column="fmax_electricity"></result>
	        <result property="minElectricity" column="fmin_electricity"></result>
	        <result property="maxValtage" column="fmax_valtage"></result>
	        <result property="minValtage" column="fmin_valtage"></result>
	        <result property="startTime" column="fstart_time"></result>
	        <result property="endTime" column="fend_time"></result>
	        <result property="material" column="fmaterial"></result>
	        <result property="nextexternaldiameter" column="fnextExternal_diameter"></result>
	        <association property="itemid" column="fitemId" javaType="com.spring.model.Insframework">  
	            <id property="id" column="iid"></id> 
	            <result property="name" column="iname"></result>  
	            <result property="logogram" column="flogogram"></result>  
	            <result property="code" column="fcode"></result>
	        	<result property="parent" column="fparent"></result>
	        	<result property="type" column="ftype"></result>
        	</association>
       	</association>
	</resultMap>
	
	<resultMap id="dtoMap" type="com.spring.dto.ModelDto">
		<id property="fid" column="fid"></id> 
        <result property="overproof" column="overproof"></result>
        <result property="weldTime" column="weldTime"></result>
        <result property="fname" column="fname"></result>
        <result property="f_welder_id" column="f_welder_id"></result>
        <result property="fmachine_id" column="fmachine_id"></result>
        <result property="fjunction_id" column="fjunction_id"></result>
        <result property="felectricity" column="felectricity"></result>
        <result property="fvoltage" column="fvoltage"></result>
        <result property="iname" column="iname"></result>
        <result property="wname" column="wname"></result>
        <result property="livecount" column="livecount"></result>
        <result property="fmax_electricity" column="fmax_electricity"></result>
        <result property="fmin_electricity" column="fmin_electricity"></result>
        <result property="overtime" column="overtime"></result>
        <result property="time" column="time"></result>
        <result property="type" column="type"></result>
        <result property="dyne" column="dyne"></result>
        <result property="num" column="num"></result>
        <result property="num1" column="num1"></result>
        <result property="num2" column="num2"></result>
        <result property="num3" column="num3"></result>
        <result property="num4" column="num4"></result>
        <result property="num5" column="num5"></result>
        <result property="num6" column="num6"></result>
        <result property="num7" column="num7"></result>
        <result property="num8" column="num8"></result>
        <result property="num9" column="num9"></result>
        <result property="num10" column="num10"></result>
        <result property="maxnum" column="maxnum"></result>
        <result property="minmun" column="minmun"></result>
        <result property="avgnum" column="avgnum"></result>
       	<result property="hous" column="hous"></result>
       	<result property="externalDiameter" column="fexternal_diameter"></result>
       	<result property="wallThickness" column="fwall_thickness"></result>
       	<result property="material" column="fmaterial"></result>
       	<result property="nextexternaldiameter" column="fnextExternal_diameter"></result>
       	<result property="nextwallThickness" column="fnextwall_thickness"></result>
       	<result property="nextmaterial" column="fnext_material "></result>
       	<result property="itemid" column="itemid"></result>
       	<result property="jidgather" column="jidgather"></result>
       	<result property="starttime" column="starttime"></result>
       	<result property="endtime" column="endtime"></result>
    </resultMap>
    
    <!-- 集团焊接工时 
	<select id="getBlochour" resultMap="dtoMap">
		SELECT *
		FROM (
		(
		SELECT count( l.fid ) AS hous, insf.fname fname, insf.fid fid,group_concat(distinct(j.fid)) jidgather
		FROM tb_live_data l
		INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		INNER JOIN tb_insframework insf ON insf.fid = ins.fparent
		WHERE fstatus &gt; 2
		AND i.ftype =23
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.search!=null and dto.search!=''">
				and ${dto.search}
			</if>
		</if>
		GROUP BY i.fparent
		)
		UNION (
		SELECT 0 AS hous, fname, fid,0 as jidgather
		FROM tb_insframework
		WHERE fid NOT
		IN (
		SELECT insf.fid
		FROM tb_live_data l
		INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
	    INNER JOIN tb_insframework insf ON insf.fid = ins.fparent
		WHERE fstatus  &gt; 2
		AND i.ftype =23
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.search!=null and dto.search!=''">
				and ${dto.search}
			</if>
		</if>
		GROUP BY i.fparent
		)
		AND ftype =21
		)
		)temp
		ORDER BY fid
	</select>-->
    

	<!-- 事业部焊接工时
	<select id="getCausehour" resultMap="dtoMap">
		select * from (
		(SELECT count( l.fid ) AS hous,  i.fname fname, i.fid fid,group_concat(distinct(j.fid)) jidgather
		FROM tb_live_data l
		INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
        INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		WHERE fstatus &gt; 2
		AND i.ftype =23
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.search!=null and dto.search!=''">
				and ${dto.search}
			</if>
		</if>
		<if test="parent==null and parent==''">
			AND i.fparent
			IN (
			SELECT fid
			FROM tb_insframework
			WHERE ftype =22
			)
		</if>
		<if test="parent!=null and parent!=''">
			AND i.fparent = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.parent!=null and dto.parent!=''">
				and ins.fparent=#{dto.parent}
			</if>
		</if>
		GROUP BY i.fname
		) 
		UNION (
		SELECT 0 AS hous, i.fname, i.fid,0 as jidgather
		FROM tb_insframework i
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		WHERE 1=1
		<if test="parent!=null and parent!=''">
			AND i.fparent = #{parent}
		</if>
		and i.fid NOT
		IN (
		SELECT i.fid
		FROM tb_live_data l
		INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
		WHERE fstatus &gt; 2
		AND i.ftype =23
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.search!=null and dto.search!=''">
				and ${dto.search}
			</if>
		</if>
		<if test="parent==null and parent==''">
			AND i.fparent
			IN (
			SELECT fid
			FROM tb_insframework
			WHERE ftype =22
			)
		</if>
		<if test="parent!=null and parent!=''">
			AND i.fparent = #{parent}
		</if>
		GROUP BY i.fname
		)
		AND i.ftype =23
		<if test="dto!=null and dto!=''">
			<if test="dto.parent!=null and dto.parent!=''">
				and ins.fparent=#{dto.parent}
			</if>
		</if>
		GROUP BY i.fname
		))temp
	</select> -->

	<!-- 公司焊接工时 -->
	<select id="getCompanyhour" resultMap="dtoMap">
		SELECT * FROM ( (
		SELECT SUM(fworktime) AS hous, ins.fname fname, ins.fid fid,group_concat(distinct(j.fid)) jidgather FROM tb_work l 
		INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no 
		INNER JOIN tb_insframework i ON i.fid = l.fitemid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE 1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.search!=null and dto.search!=''">
				and ${dto.search}
			</if>
		</if>
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if>
		GROUP BY i.fparent ) 
		UNION ( 
		SELECT 0 AS hous, fname, fid,0 as jidgather FROM tb_insframework 
		WHERE 1=1 
		<if test="parent!=null and parent!=''">
			AND fparent = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoId!=null and dto.dtoId!=''">
				and fid = #{dto.dtoId}
			</if>
		</if>
		and fid NOT IN ( 
		SELECT ins.fid FROM tb_work l INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no 
		INNER JOIN tb_insframework i ON i.fid = l.fitemid 
		LEFT JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE 1=1 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.search!=null and dto.search!=''">
				and ${dto.search}
			</if>
		</if>
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if>
		GROUP BY i.fparent ) 
		AND ftype =22 ) 
		)temp
	</select>

	<!-- 项目部焊口工时 
	<select id="getItemhour" resultMap="dtoMap">
		select * from (
		SELECT count( l.fid ) AS hous, fmaterial, fexternal_diameter, fwall_thickness, fnextExternal_diameter,fnext_material nextmaterial , fnextwall_thickness,group_concat(distinct(j.fid)) jidgather,j.fitemid itemid
		FROM tb_live_data l
		INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		WHERE fstatus &gt; 2
		<if test="dto!=null and dto!=''">
			<if test="dto.parent!=null and dto.parent!=''">
				AND i.fparent =#{dto.parent}
			</if>
			<if test="dto.companyid!=null and dto.companyid!=''">
				AND ins.fparent =#{dto.companyid}
			</if>
		</if>
		AND i.ftype =23
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.dtoItem!=null and dto.dtoItem!=''">
				AND j.fitemid =#{dto.dtoItem}
			</if>
			<if test="dto.search!=null and dto.search!=''">
				and (${dto.search})
			</if>
		</if>
		GROUP BY fmaterial, fexternal_diameter, fwall_thickness, fnextExternal_diameter,fnext_material,fnextwall_thickness,l.fitemid
		 )temp
	</select>-->
	
	<!-- 获取焊口分类 -->
	<select id="getHousClassify" resultMap="dtoMap">
		select j.fid, fmaterial, fexternal_diameter, fwall_thickness, fnextExternal_diameter,fnext_material nextmaterial , fnextwall_thickness from tb_welded_junction j
		INNER JOIN tb_insframework i ON i.fid = j.fitemid
        INNER JOIN tb_insframework ins ON ins.fid = i.fparent
        where 1=1
		<if test="parent!=null and parent!=''">
			and (i.fid=#{parent} or ins.fid=#{parent} or ins.fparent=#{parent})
		</if>
		<if test="str!=null and str!=''">
			and ${str}
		</if>
		group by fmaterial, fexternal_diameter, fwall_thickness, fnextExternal_diameter,fnext_material,fnextwall_thickness
	</select>
	
	<!-- 项目部工时明细 
	<select id="getJunctionHous" resultMap="dtoMap">
		SELECT *
		FROM (
		SELECT count( l.fid ) AS hous, sum( fdyne ) dyne, fjunction_id fname, j.fid fid,j.fstart_time starttime,j.fend_time endtime,i.fname iname,GROUP_CONCAT(DISTINCT(w.fname)) fwelder_id
		FROM tb_live_data l
		INNER JOIN tb_welded_junction j ON l.fjunction_id = j.fwelded_junction_no
		INNER JOIN tb_insframework i ON l.fitemid = i.fid
		Left JOIN tb_welder w ON w.fwelder_no = l.fwelder_id
		WHERE fstatus &gt; 2
		AND i.ftype =23
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.dtoMaterial!=null and dto.dtoMaterial!=''">
				AND fmaterial = #{dto.dtoMaterial}
			</if>
			<if test="dto.dtoExternalDiameter!=null and dto.dtoExternalDiameter!=''">
				AND fexternal_diameter = #{dto.dtoExternalDiameter}
			</if>
			<if test="dto.dtoWallThickness!=null and dto.dtoWallThickness!=''">
				AND fwall_thickness = #{dto.dtoWallThickness}
			</if>
			<if test="dto.nextmaterial!=null and dto.nextmaterial!=''">
				AND fnext_material = #{dto.nextmaterial}
			</if>
			<if test="dto.nextwallthickness!=null and dto.nextwallthickness!=''">
				AND fnextwall_thickness = #{dto.nextwallthickness}
			</if>
			<if test="dto.dtoNextExternalDiameter!=null and dto.dtoNextExternalDiameter!=''">
				AND fnextExternal_diameter = #{dto.dtoNextExternalDiameter}
			</if>
			<if test="dto.dtoItem!=null and dto.dtoItem!=''">
				AND j.fitemid = #{dto.dtoItem}
			</if>
			<if test="dto.parent!=null and dto.parent!=''">
				and i.fparent = #{dto.parent}
			</if>
		</if>
		group by fjunction_id
		)temp
	</select>-->

	<!-- 集团超标统计
	<select id="getBlocOverproof" resultMap="dtoMap">
		select * from
		(
		select sum(OverFlage) as overproof ,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if>
		weldtime ,fname,fid from 
		(
		SELECT case when felectricity  &gt; fmax_electricity then 1 when felectricity &lt; fmin_electricity then 1 else 0  end as OverFlage,fweldtime,insf.fname, insf.fid
		FROM 
		(
		select fid,felectricity,fstatus,fjunction_id,fweldtime,fitemid from tb_live_data where fstatus = 3
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		) as k0 inner join tb_welded_junction j on j.fwelded_junction_no=k0.fjunction_id
		inner join tb_insframework i on k0.fitemid = i.fid
		inner join tb_insframework ins on ins.fid = i.fparent
		inner join tb_insframework insf on insf.fid = ins.fparent
		 where i.ftype=23
		) as K 
		group by fid,weldtime
		) temp
	</select> -->
	
	<!-- 公司超标统计 -->
	<select id="getCompanyOverproof" resultMap="dtoMap">
		select * from (
		select sum(falarmtime) as overproof,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldtime ,ins.fname,ins.fid from  tb_alarm l 
		inner join tb_welded_junction j on j.fwelded_junction_no=l.fjunction_id 
		inner join tb_insframework i on l.fitemid = i.fid 
		inner join tb_insframework ins on ins.fid = i.fparent 
		where 1=1
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if> 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				AND fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				AND fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by fid,weldtime
		)temp
	</select>
	
	<!-- 事业部超标统计 
	<select id="getCauseOverproof" resultMap="dtoMap">
	SELECT * FROM (
	SELECT sum( OverFlage ) AS overproof, 
	<if test="dto!=null and dto!=''">
		<if test="dto.year!=null and dto.year!=''">
			DATE_FORMAT( fweldtime,  '%Y' )
		</if>
		<if test="dto.month!=null and dto.month!=''">
			DATE_FORMAT( fweldtime,  '%Y-%m' )
		</if>
		<if test="dto.day!=null and dto.day!=''">
			DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
		</if>
		<if test="dto.week!=null and dto.week!=''">
			weekofyear(fweldtime)
		</if>
	</if> weldTime,fid,fname
	FROM (
	SELECT case when felectricity  &gt; fmax_electricity then 1 when felectricity &lt; fmin_electricity then 1 else 0  end
	AS OverFlage, fweldtime, i.fname, i.fid
	FROM (
	SELECT fid, felectricity, fstatus, fjunction_id, fweldtime,fitemid
	FROM tb_live_data
	WHERE fstatus = 3
	<if test="dto!=null and dto!=''">
		<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
			and fweldtime &gt;= #{dto.dtoTime1}
		</if>
		<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
			and fweldtime &lt;= #{dto.dtoTime2}
		</if>
	</if>
	) AS k0
	INNER JOIN tb_welded_junction j ON j.fwelded_junction_no = k0.fjunction_id
	INNER JOIN tb_insframework i ON k0.fitemid = i.fid
	INNER JOIN tb_insframework ins ON ins.fid = i.fparent
	WHERE i.ftype =23
	<if test="parent!=null and parent!=''">
		AND i.fparent = #{parent}
	</if>
	<if test="dto!=null and dto!=''">
		<if test="dto.companyid!=null and dto.companyid!=''">
			 AND ins.fparent = #{dto.companyid}
		</if>
	</if>
	) AS K
	GROUP BY fid,weldTime
	)temp
	</select>-->
	
	<!-- 项目部超标统计 
	<select id="getItemOverproof" resultMap="dtoMap">
		SELECT * FROM (
		SELECT sum( OverFlage ) AS overproof, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if> weldTime,fid,fname
		FROM (
		SELECT case when felectricity  &gt; fmax_electricity then 1 when felectricity &lt; fmin_electricity then 1 else 0  end
		AS OverFlage, fweldtime, i.fname, i.fid
		FROM (
		SELECT fid, felectricity, fstatus, fjunction_id, fweldtime,fitemid
		FROM tb_live_data
		WHERE fstatus = 3
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		) AS k0
		INNER JOIN tb_welded_junction j ON j.fwelded_junction_no = k0.fjunction_id
		INNER JOIN tb_insframework i ON k0.fitemid = i.fid
		WHERE i.ftype =23 
		<if test="id!=null and id!=''">
			AND i.fid = #{id}
		</if>
		) AS K
		GROUP BY fid,weldTime
		)temp
	</select>-->
	
	<!-- 查询所有在范围内的时间 -->
	<select id="getAllTime" resultMap="dtoMap">
		select * from (
		SELECT 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldTime
		FROM tb_work WHERE 1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by weldTime
        UNION  
		SELECT 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldTime
		FROM tb_standby WHERE 1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by weldTime order by weldTime
     	)temp
	</select>
	
	<select id="getAllInsf" resultMap="liveMap">
		SELECT i.fid,i.fname from tb_insframework i
		inner join tb_insframework ins on ins.fid = i.fparent
		inner join tb_insframework insf on insf.fid = ins.fparent
		where i.ftype=#{type}
		<if test="parent!=null and parent!=''">
			and (i.fid = #{parent} or ins.fparent = #{parent} or i.fparent=#{parent})
		</if>
	</select>
	
	<!-- 超标明细 
	<select id="getDatailOverproof" resultMap="dtoMap">
		select * from(
		select sum(OverFlage) overproof,k.* from (
		select case when felectricity &gt; fmax_electricity then 1 when felectricity &lt; fmin_electricity then 1 else 0 end as OverFlage, 
		i.fid iid,j.fid jid,fmax_electricity,fmin_electricity,felectricity,DATE_FORMAT(fweldtime,'%Y-%m-%d') weldtime ,fgather_no jidgather,
		i.fname iname,fwelder_id,fequipment_no fmachine_id,fjunction_id,k0.fname wname from ( 
		select felectricity,fjunction_id,fweldtime,fwelder_id,fequipment_no,l.fgather_no,w.fname,l.fitemid from tb_live_data l left join tb_welder w on l.fwelder_id = w.fwelder_no
        LEFT JOIN tb_welding_machine m on m.fid = l.fmachine_id where l.fstatus=3 ) as k0 
		inner join tb_welded_junction j on j.fwelded_junction_no=k0.fjunction_id 
		inner join tb_insframework i on k0.fitemid = i.fid 
		where i.ftype=23
		<if test="parent!=null and parent!=''">
			AND i.fid = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.time!=null and dto.time!=''">
				and fweldtime like #{dto.time}
			</if>
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		)k group by fwelder_id,jid,fmachine_id,weldtime
		)temp
	</select>-->
	<!--
	<select id="getCountTime" resultType="java.lang.Integer" >
		 select count(l.fid) from tb_live_data l inner join tb_welded_junction j on j.fwelded_junction_no = l.fjunction_id 
		 inner join tb_insframework i on i.fid = l.fitemid
         INNER join tb_welding_machine m on m.fid = l.fmachine_id
		 where i.fid = #{id} and fwelder_id=#{welderno} and fequipment_no=#{machineno} and fjunction_id=#{junctionno} and DATE_FORMAT(fweldtime,'%Y-%m-%d') = #{time}
	</select>  -->
	
	<!-- 超标回溯 
	<select id="getjunctionoverproof" resultMap="dtoMap">
		SELECT case when felectricity  &gt; fmax_electricity then 1
		when felectricity &lt; fmin_electricity then 1 else 0  end  as overproof,fweldtime weldtime,fjunction_id
		FROM tb_live_data l inner join tb_welded_junction j on l.fjunction_id=j.fwelded_junction_no 
		inner join tb_insframework i on i.fid = l.fitemid
        LEFT JOIN tb_welding_machine m on m.fid = l.fmachine_id
		where DATE_FORMAT(fweldtime,'%Y-%m-%d')  = DATE_FORMAT(#{time},'%Y-%m-%d')
 		and fjunction_id=#{junctionno} and fwelder_id=#{welderno} and fequipment_no=#{machineno} and i.fid = #{id}  group by fweldtime
	</select>-->
	
	<!-- 集团超时待机统计 
	<select id="getBlocOvertime" resultMap="dtoMap">
		SELECT * from (
		select sum(num) overtime,fid,fname,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( times,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( times,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( times,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(times)
			</if>
		</if> weldTime from (
        SELECT case when count(l.fid)/60 &gt;= #{num} then 1 else 0 end as num,fmachine_id,insf.fid,insf.fname,DATE_FORMAT( fweldtime,'%Y-%m-%d' ) times
		FROM tb_live_data l 
        INNER JOIN tb_insframework i on i.fid = l.fitemid
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		INNER JOIN tb_insframework insf ON insf.fid = ins.fparent
		WHERE fstatus =0
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by fmachine_id ,times  
    	)k group by fid,weldTime
        )temp
	</select>-->
	
	<!-- 公司超时待机统计 -->
	<select id="getcompanyOvertime" resultMap="dtoMap">
		select * from (
		select sum(num) overtime,fid,fname,weldTime from (
		select case when SUM(fstandbytime)/60 &gt;= #{num} then 1 else 0 end as num,ins.fid,ins.fname, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if>weldTime from tb_standby l 
		INNER JOIN tb_insframework i on i.fid = l.fitemid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE 1=1 
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by fmachine_id ,weldTime
		) A group by fid,weldTime
		)temp
	</select>
	
	<!-- 事业部超时待机统计 
	<select id="getCaustOvertime" resultMap="dtoMap">
		SELECT * from (
		select sum(num) overtime,fid,fname,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( times,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( times,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( times,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(times)
			</if>
		</if> weldTime from (
        SELECT case when count(l.fid)/60 &gt;= #{num} then 1 else 0 end as num,fmachine_id,i.fid,i.fname,DATE_FORMAT( fweldtime,'%Y-%m-%d' ) times
		FROM tb_live_data l 
        INNER JOIN tb_insframework i on i.fid = l.fitemid
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		WHERE fstatus =0
		<if test="parent!=null and parent!=''">
			AND (i.fparent = #{parent} or ins.fparent = #{parent})
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by fmachine_id ,times  
    	)k group by fid,weldTime
        )temp
	</select>-->
	
	<!-- 项目部超时待机统计 
	<select id="getItemOvertime" resultMap="dtoMap">
		SELECT * from (
		select sum(num) overtime,fid,fname,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( times,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( times,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( times,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(times)
			</if>
		</if> weldTime from (
        SELECT case when count(l.fid)/60 &gt;= #{num} then 1 else 0 end as num,fmachine_id,i.fid,i.fname,DATE_FORMAT( fweldtime,'%Y-%m-%d' ) times
		FROM tb_live_data l 
        INNER JOIN tb_insframework i on i.fid = l.fitemid
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		WHERE fstatus =0
		<if test="dto!=null and dto!=''">
			<if test="dto.parent!=null and dto.parent!=''">
				AND (i.fid = #{dto.parent} or i.fparent = #{dto.parent} or ins.fparent = #{dto.parent})
			</if>
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by fmachine_id ,times  
    	)k group by fid,weldTime
        )temp
	</select>-->
	
	<!-- 获取所有焊口 -->
	<select id="getJunction" resultMap="liveMap">
		SELECT j.fid,fwelded_junction_no fname,fitemid itemid FROM tb_welded_junction j
		inner join tb_insframework i on i.fid = j.fitemId
		inner join tb_insframework ins on ins.fid = i.fparent
		WHERE 1=1 
		<if test="parent!=null and parent!=''">
			and  (i.fid = #{parent} or ins.fid = #{parent} or ins.fparent=#{parent})
		</if>
	</select>
	
	<!-- 待机明细 
	<select id="getDetailovertime" resultMap="dtoMap">
		SELECT * from (select sum(num) overtime,fid,fname,wname,fequipment_no fmachine_id, fwelder_id, weldTime from (
		SELECT case when count(l.fid)/60 &gt;=#{num} then 1 else 0 end as num,fequipment_no,i.fid,i.fname,w.fname wname,fwelder_id,
		DATE_FORMAT( fweldtime,'%Y-%m-%d' ) weldTime
		FROM tb_live_data l 
        inner join tb_welding_machine m on l.fmachine_id = m.fid
        INNER join tb_insframework i on i.fid = l.fitemid
        left join tb_welder w on w.fwelder_no = l.fwelder_id
		WHERE fstatus =0 AND i.fid=#{parent}
		<if test="dto!=null and dto!=''">
			<if test="dto.time!=null and dto.time!=''">
				and fweldtime like #{dto.time}
			</if>
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by fmachine_id ,weldTime ,fwelder_id
    	)k group by fequipment_no ,fwelder_id
        )temp
	</select>-->
	
	<!-- 集团负荷率 
	<select id="getBlocLoads" resultMap="dtoMap">
		select * from (
		SELECT 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				COUNT( lid ) / ( 12 *30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				COUNT( lid ) / ( 30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				COUNT( lid ) / ( 8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				COUNT( lid ) / ( 7 *8 *60 *60 ) AS loads, 
				weekofyear(fweldtime)
			</if>
		</if>
		AS weldTime,insf.fid iid, insf.fname
		FROM  
		(
		SELECT fid lid,  fitemid, fweldtime
		FROM tb_live_data
		WHERE fstatus &gt; 2
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		) AS k0
        INNER JOIN tb_insframework i ON k0.fitemid = i.fid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		INNER JOIN tb_insframework insf ON insf.fid = ins.fparent
		WHERE i.ftype =23
		GROUP BY  iid, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if>
		) temp
	</select>-->
	
	<!-- 公司负荷率 -->
	<select id="getCompanyLoads" resultMap="dtoMap">
		select * from (
		select 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				sum(fworktime) / ( 12 *30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				sum(fworktime) / ( 30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				sum(fworktime) / ( 8 *60 *60 ) AS loads, 
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				sum(fworktime) / ( 7 *8 *60 *60 ) AS loads, 
				weekofyear(fstarttime)
			</if>
		</if>
		AS weldTime,ins.fid iid, ins.fname  from tb_work l 
		INNER JOIN tb_insframework i ON l.fitemid = i.fid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE 1=1 
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				AND fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				AND fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		GROUP BY iid, weldTime
		)temp
	</select>
	
	<!-- 事业部负荷率
	<select id="getCaustLoads" resultMap="dtoMap">
		select * from(
		SELECT 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				COUNT( lid ) / ( 12 *30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				COUNT( lid ) / ( 30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				COUNT( lid ) / ( 8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				COUNT( lid ) / ( 7 *8 *60 *60 ) AS loads, 
				weekofyear(fweldtime)
			</if>
		</if>
		AS weldTime,i.fname,i.fid iid
		FROM  
		(
		SELECT fid lid,fitemid, fweldtime
		FROM tb_live_data
		WHERE fstatus &gt; 2
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		) AS k0
        INNER JOIN tb_insframework i ON k0.fitemid = i.fid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE i.ftype =23
		<if test="parent!=null and parent!=''">
			AND (i.fparent = #{parent} or ins.fparent = #{parent})
		</if>
		GROUP BY  iid, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if>
		)temp
	</select> -->
	
	<!-- 获取项目部负荷率 
	<select id="getItemLoads"  resultMap="dtoMap">
		select * from (
		SELECT 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				COUNT( lid ) / ( 12 *30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				COUNT( lid ) / ( 30 *8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				COUNT( lid ) / ( 8 *60 *60 ) AS loads, 
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				COUNT( lid ) / ( 7 *8 *60 *60 ) AS loads, 
				weekofyear(fweldtime)
			</if>
		</if> 
		weldTime,i.fid iid,i.fname
		FROM  
		(
		SELECT fid lid, fitemid, fweldtime
		FROM tb_live_data
		WHERE fstatus &gt; 2
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		) AS k0
        INNER JOIN tb_insframework i ON k0.fitemid = i.fid 
		WHERE i.ftype =23 
		<if test="parent!=null and parent!=''">
				AND i.fid = #{parent}
		</if>
		GROUP BY weldTime
		)temp
	</select>-->
	
	<!-- 获取所有焊机 -->
	<select id="getMachine" resultMap="liveMap">
		SELECT m.fid,fequipment_no fname,finsframework_id itemid FROM tb_welding_machine m 
		inner join tb_insframework i on m.finsframework_id = i.fid
		inner join tb_insframework ins on ins.fid = i.fparent
		WHERE 1=1 
		<if test="parent!=null and parent!=''">
			 and (i.fid = #{parent} or i.fparent = #{parent} or ins.fparent = #{parent})
		</if>
	</select>
	
	<!-- 负载率明细
	<select id="getDetailLoads" resultMap="dtoMap">
		SELECT * FROM (
		SELECT
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				COUNT( lid ) / ( 12 *30 *8 *60 *60 ) 
			</if>
			<if test="dto.month!=null and dto.month!=''">
				COUNT( lid ) / ( 30 *8 *60 *60 )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				COUNT( lid ) / ( 8 *60 *60 ) 
			</if>
			<if test="dto.week!=null and dto.week!=''">
				COUNT( lid ) / ( 7 *8 *60 *60 ) 
			</if>
		</if> loads,fweldtime,i.fid,i.fname,fgather_no , m.fequipment_no fmachine_id
		FROM  
		(
		SELECT fid lid, fitemid, fweldtime,fgather_no,fmachine_id
		FROM tb_live_data
		WHERE fstatus &gt; 2
		<if test="dto!=null and dto!=''">
			<if test="dto.time!=null and dto.time!=''">
				and fweldtime like #{dto.time}
			</if>
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		) AS k0
        INNER JOIN tb_insframework i ON k0.fitemid = i.fid 
		LEFT JOIN tb_welding_machine m ON m.fid = k0.fmachine_id
		WHERE i.ftype =23 
		<if test="dto!=null and dto!=''">
			<if test="dto.parent!=null and dto.parent!=''">
				AND i.fid = #{dto.parent}
			</if>
		</if>
		GROUP BY fmachine_id
		)temp
	</select> -->
	
	<!-- 集团空载率 
	<select id="getBlocNoLoads" resultMap="dtoMap">
		SELECT * 
		FROM (
		SELECT COUNT( lid ) AS loads, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if>
		weldTime, insf.fname, insf.fid iid
		FROM (
		SELECT fid lid, fitemid, fweldtime
		FROM tb_live_data
		WHERE 1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		AND fstatus =0
		) AS k0
        INNER JOIN tb_insframework i ON k0.fitemId = i.fid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		INNER JOIN tb_insframework insf ON insf.fid = ins.fparent
		WHERE i.ftype =23
		GROUP BY iid, weldTime
		)temp
	</select>-->
	
	<!-- 公司空载率 -->
	<select id="getCompanyNoLoads" resultMap="dtoMap">
		select * from (select SUM(fstandbytime) AS loads, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldTime, ins.fname, ins.fid iid from tb_standby l 
		INNER JOIN tb_insframework i ON l.fitemId = i.fid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent  
		WHERE 1=1 
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				AND fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				AND fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if> GROUP BY iid, weldTime
		)temp
	</select>

	<!-- 事业部空载率
	<select id="getCaustNoLoads" resultMap="dtoMap">
		SELECT * 
		FROM (
		SELECT COUNT( lid ) AS loads, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if>
		weldTime, i.fname,  i.fid iid
		FROM (
		SELECT fid lid,fitemid, fweldtime
		FROM tb_live_data
		WHERE 1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		AND fstatus =0
		) AS k0
        INNER JOIN tb_insframework i ON k0.fitemId = i.fid 
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE i.ftype =23
		<if test="parent!=null and parent!=''">
			AND (i.fparent = #{parent} or ins.fparent = #{parent})
		</if>
		GROUP BY iid, weldTime
		)temp
	</select> -->
	
	<!-- 项目部空载率 
	<select id="getItemNOLoads" resultMap="dtoMap">
		SELECT * 
		FROM (
		SELECT COUNT( lid ) AS loads,	
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if>
		weldTime,fname,fid
		FROM (
		SELECT i.fid, l.fid lid, fweldtime, i.fname
		FROM tb_live_data l
        INNER JOIN tb_insframework i ON l.fitemid = i.fid 
		WHERE i.ftype =23 and fstatus =0
		<if test="parent!=null and parent!=''">
				and i.fid = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		)k1
		GROUP BY  weldTime
		)temp
	</select>-->
	
	<!-- 空载率明细 
	<select id="getDetailNoLoads" resultMap="dtoMap">
		SELECT * 
		FROM (
		SELECT COUNT( lid ) AS loads,fweldtime weldTime,fname,fid,fmachine_id
		FROM (
		SELECT i.fid, l.fid lid, fweldtime, i.fname,m.fequipment_no fmachine_id,m.fid jid
		FROM tb_live_data l
        INNER JOIN tb_insframework i ON l.fitemid = i.fid 
		LEFT JOIN tb_welding_machine m ON m.fid = l.fmachine_id
		WHERE i.ftype =23 and l.fstatus =0 
		<if test="dto!=null and dto!=''">
			<if test="dto.parent!=null and dto.parent!=''">
				AND i.fid = #{dto.parent}
			</if>
			<if test="dto.time!=null and dto.time!=''">
				and fweldtime like #{dto.time}
			</if>
		</if>
		)k1
		GROUP BY  fmachine_id
		)temp
	</select>-->
	
	<!-- 集团闲置率 
	<select id="getBlocIdle" resultMap="dtoMap">
		SELECT * FROM(
		SELECT count(fequipment_no) num,weldTime,fname,fid from(
        SELECT m.fequipment_no, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if> weldTime ,insf.fname,insf.fid FROM tb_live_data l
		INNER JOIN tb_welding_machine m ON m.fid = l.fmachine_id
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
		inner join tb_insframework ins on ins.fid = i.fparent
		INNER JOIN tb_insframework insf ON insf.fid = ins.fparent
		WHERE  1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		GROUP BY weldTime,fequipment_no )k group by weldTime,fid
		) TEMP
	</select>-->

	<!-- 公司闲置率 -->
	<select id="getCompanyIdle" resultMap="dtoMap">
		SELECT * from (
		select count(mid) num,fid,fname,weldTime from (
		select m.fid mid,ins.fid,ins.fname,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldTime from tb_work l 
		INNER JOIN tb_welding_machine m ON m.fid = l.fmachine_id 
		INNER JOIN tb_insframework i ON i.fid = l.fitemid 
		INNER JOIN tb_insframework ins on ins.fid = i.fparent 
		WHERE  1=1 
		<if test="parent!=null and parent!=''">
			and (i.fid = #{parent} OR ins.fid = #{parent} OR ins.fparent=#{parent}) 
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>GROUP BY weldTime,fequipment_no)A group by  weldTime,fid
		)temp
	</select>

	<!-- 事业部闲置率 
	<select id="getCaustIdle" resultMap="dtoMap">
		SELECT * FROM(
		SELECT count(fequipment_no) num,weldTime,fname,fid from(
        SELECT m.fequipment_no, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if> weldTime ,i.fname,i.fid FROM tb_live_data l
		INNER JOIN tb_welding_machine m ON m.fid = l.fmachine_id
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
		INNER JOIN tb_insframework ins on ins.fid = i.fparent
		WHERE 1=1
		<if test="parent!=null and parent!=''">
			    and (i.fparent=#{parent} or ins.fparent=#{parent})
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		GROUP BY weldTime,fequipment_no )k group by weldTime,fid
		) TEMP
	</select>-->
	
	<!-- 项目部闲置率 
	<select id="getItemidle" resultMap="dtoMap">
		SELECT * FROM(
		SELECT count(fequipment_no) num,weldTime,fname from(
        SELECT m.fequipment_no, 
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fweldtime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fweldtime,  '%Y-%m' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fweldtime)
			</if>
		</if>
		weldTime ,i.fname FROM tb_live_data l
		INNER JOIN tb_welding_machine m ON m.fid = l.fmachine_id
		INNER JOIN tb_insframework i ON i.fid = l.fitemid
		WHERE  i.fid = #{itemid}
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		GROUP BY weldTime,fequipment_no )k group by weldTime
		) TEMP
	</select>-->
	
	<select id="getMachineCount" resultType="java.lang.Integer">
		SELECT count(w.fid) from tb_welding_machine w
		INNER JOIN tb_insframework i on i.fid = w.finsframework_id
		INNER JOIN tb_insframework ins on ins.fid = i.fparent
		where 1=1
		<if test="id!=null and id!=''">
			and (i.fid=#{id} or ins.fid=#{id} or ins.fparent=#{id})
		</if>
	</select>
	
	<!-- 集团单台设备运行数据统计 
	<select id="getBlocUse" resultMap="dtoMap">
		select * from(
		select count(l.fid)/60/60 time,e.fname fname,e.ftype type,e.fid fid from tb_live_data l 
		inner join tb_welding_machine w on w.fid = l.fmachine_id
		inner join tb_equipment_manufacturer e on w.fmanufacturer_id = e.fid 
		where w.finsframework_id in 
		(select i.fid from tb_insframework  i inner join  tb_insframework ins on ins.fid = i.fparent where ins.fparent=#{parent})
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by  e.fid,e.ftype
		union
		select 0 time,fname ,ftype type,fid from tb_equipment_manufacturer
		where fid not in
		(
		select e.fid from tb_live_data l 
		inner join tb_welding_machine w on w.fid = l.fmachine_id
		inner join tb_equipment_manufacturer e on w.fmanufacturer_id = e.fid 
		where w.finsframework_id in 
		(select i.fid from tb_insframework i inner join  tb_insframework ins on ins.fid = i.fparent where ins.fparent=#{parent})
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by  e.fid,e.ftype
		)
		)temp  order by fname,time desc
	</select>-->
	
	<!-- 公司单台设备运行数据统计 -->
	<select id="getCompanyUse" resultMap="dtoMap">
		select * from(
		select sum(fworktime)/60/60 time,d.fvaluename fname,d.fvalue fid from tb_work l 
		inner join tb_welding_machine w on w.fid = l.fmachine_id
        inner join tb_dictionary d on d.fvalue = w.fmanufacturer_id
		where d.ftypeid=14 and w.finsframework_id in (select fid from tb_insframework where fparent=15)
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by d.fvalue
		union
		select 0 time,fvaluename fname ,fvalue fid from tb_dictionary
		where ftypeid=14 and fvalue not in
		(
		select d.fvalue from tb_work l 
		inner join tb_welding_machine w on w.fid = l.fmachine_id
        inner join tb_dictionary d on d.fvalue = w.fmanufacturer_id
		where d.ftypeid=14 and w.finsframework_id in (select fid from tb_insframework where fparent=15)
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by d.fvalue
		)
		)temp order by fname ,time desc
	</select>
	
	<!-- 事业部单台设备运行数据统计
	<select id="getCaustUse" resultMap="dtoMap">
		select * from (
		select count(l.fid)/60/60 time,e.fname fname,e.ftype type,e.fid fid from tb_live_data l 
		inner join tb_welding_machine w on w.fid = l.fmachine_id
		inner join tb_equipment_manufacturer e on w.fmanufacturer_id = e.fid 
		where w.finsframework_id =#{insid}
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by e.fid,e.ftype
		union
		select 0 time,fname ,ftype type,fid from tb_equipment_manufacturer
		where fid not in
		(
		select e.fid from tb_live_data l 
		inner join tb_welding_machine w on w.fid = l.fmachine_id
		inner join tb_equipment_manufacturer e on w.fmanufacturer_id = e.fid 
		where w.finsframework_id =#{insid}
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by e.fid,e.ftype
		)
		)temp order by fname,time desc
	</select> -->
	
	<!--  项目部单台设备运行数据统计
	<select id="getItemUse" resultMap="dtoMap">
		select * from ( select count(l.fid)/60/60 time,e.fname fname,e.ftype type,e.fid fid from tb_live_data l 
		inner join tb_welding_machine w on w.fid = l.fmachine_id 
		inner join tb_equipment_manufacturer e on w.fmanufacturer_id = e.fid 
		inner join  tb_insframework i on i.fid = w.finsframework_id 
		inner join  tb_insframework ins on ins.fid = i.fparent
		inner join  tb_insframework insf on insf.fid = ins.fparent
		where (i.fid=#{insid} or ins.fid = #{insid} or insf.fid=#{insid} or insf.fparent=#{insid}) 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if> 
		group by e.fid,e.ftype union select 0 time,fname ,ftype type,fid from tb_equipment_manufacturer where fid not in ( 
		select e.fid from tb_live_data l inner join tb_welding_machine w on w.fid = l.fmachine_id 
		inner join tb_equipment_manufacturer e on w.fmanufacturer_id = e.fid 
		inner join  tb_insframework i on i.fid = w.finsframework_id 
		inner join  tb_insframework ins on ins.fid = i.fparent 
		inner join  tb_insframework insf on insf.fid = ins.fparent
		where (i.fid=#{insid} or ins.fid = #{insid} or insf.fid=#{insid} or insf.fparent=#{insid}) 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		 group by e.fid,e.ftype ) )temp order by fname,time desc
	</select>-->
	
	<!-- 	公司工效列表 -->
	<select id="companyEfficiency" resultMap="dtoMap">
		select * from (
		select * from (
		SELECT ins.fid fid,ins.fname iname,w.fname wname,l.fwelder_id fwelder_id,SUM(fworktime)/60/60 weldtime,group_concat(DISTINCT(j.fid)) jidgather
		FROM tb_work l left join tb_welder w on l.fwelder_id = w.fwelder_no
		inner join tb_welded_junction j on l.fjunction_id = j.fwelded_junction_no
		inner join tb_insframework i on i.fid = l.fitemid
		inner join tb_insframework ins on ins.fid = i.fparent
		where 1=1 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		<if test="parent!=null and parent!=''">
			AND (i.fid = #{parent} or i.fparent=#{parent} or ins.fparent=#{parent}) 
		</if>
		group by i.fid,fwelder_id
		)A 
		<if test="min>=0 and max>=0">
			where weldtime &gt;=#{min} and weldtime &lt;= #{max}
		</if>
		group by fwelder_id
		)temp
	</select>
	
	<!-- 	集团工效列表
	<select id="blocEfficiency" resultMap="dtoMap">
		select * from (
		select * from (
		SELECT insf.fid,insf.fname iname,w.fname wname,l.fwelder_id fwelder_id,round(COUNT(l.fid)/60/60) weldtime,group_concat(DISTINCT(j.fid)) jidgather
		FROM tb_live_data l left join tb_welder w on l.fwelder_id = w.fwelder_no
		inner join tb_welded_junction j on l.fjunction_id = j.fwelded_junction_no
		inner join tb_insframework i on i.fid = l.fitemid
		inner join tb_insframework ins on ins.fid = i.fparent
		inner join tb_insframework insf on insf.fid = ins.fparent
		where 1=1 
		<if test="parent!=null and parent!=''">
			AND insf.fid=#{parent} 
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by i.fid,w.fname
		)A 
		<if test="min>=0 and max>=0">
			where weldtime &gt;=#{min} and weldtime &lt;= #{max}
		</if>
		group by wname
		)temp
	</select> -->
	
	<!-- 	事业部工效列表 
	<select id="caustEfficiency" resultMap="dtoMap">
		select * from (
		select * from (
		SELECT i.fid fid,i.fname iname,w.fname wname,l.fwelder_id fwelder_id, round(COUNT(l.fid)/60/60) weldtime,group_concat(DISTINCT(j.fid)) jidgather
		FROM tb_live_data l left join tb_welder w on l.fwelder_id = w.fwelder_no
		inner join tb_welded_junction j on l.fjunction_id = j.fwelded_junction_no
		inner join tb_insframework i on i.fid = l.fitemid
		inner join tb_insframework ins on ins.fid = i.fparent
		where 1=1 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fweldtime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fweldtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		<if test="parent!=null and parent!=''">
			AND (i.fid = #{parent} or i.fparent=#{parent} or ins.fparent=#{parent}) 
		</if>
		group by i.fid,w.fname
		)A 
		<if test="min>=0 and max>=0">
			where weldtime &gt;=#{min} and weldtime &lt;= #{max}
		</if>
		group by wname
		)temp
	</select>-->

	<!-- 	根据焊口获取总达因值 -->
	<select id="getDyneByJunctionno"  resultType="java.math.BigInteger">
		select SUM(fdyne) FROM tb_welded_junction where 1=1 
		<if test="str!=null and str!=''">
			${str}
		</if>
	</select>
	
	<select id="getBlocChildren" resultMap="liveMap">
		SELECT fid,fname from tb_insframework where ftype=21
	</select>
	
	<!-- 查询工效最大值，最小值以及平均跨度 -->
	<select id="getEfficiencyChartNum" resultMap="dtoMap">
		select * from (select max(num) maxnum,min(num) minnum,round((max(num)-min(num))/10) avgnum,sum(num) num from (select round(sum(fworktime)/60/60) num
		FROM tb_work l left join tb_welder w on l.fwelder_id = w.fwelder_no
		inner join tb_welded_junction j on l.fjunction_id = j.fwelded_junction_no
		inner join tb_insframework i on i.fid = l.fitemid
		inner join tb_insframework ins on ins.fid = i.fparent
		where 1=1
		<if test="parent!=null and parent!=''">
			AND (i.fid = #{parent} or i.fparent=#{parent} or ins.fparent=#{parent}) 
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by i.fid,w.fname ORDER by num)A)temp
	</select>
	
	<!-- 工效图表 ps:最后一位+10 是为了避免去整时舍去小数点导致范围小于最大值 -->
	<select id="getEfficiencyChart" resultMap="dtoMap">
		select * from (
		select sum(num1) sum1,sum(num2) sum2,sum(num3) sum3,sum(num4) sum4,sum(num5) sum5,sum(num6) sum6,sum(num7) sum7,sum(num8) sum8,sum(num9) sum9,sum(num10) sum10 from (select 
		case when round(sum(fworktime)/60/60)&gt;=#{minnum} and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum} then 1 else 0 end as num1,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum} and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*2 then 1 else 0 end as num2,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*2 and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*3 then 1 else 0 end as num3,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*3 and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*4 then 1 else 0 end as num4,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*4 and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*5 then 1 else 0 end as num5,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*5 and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*6 then 1 else 0 end as num6,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*6 and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*7 then 1 else 0 end as num7,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*7 and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*8 then 1 else 0 end as num8,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*8 and round(sum(fworktime)/60/60)&lt;=#{minnum}+#{avgnum}*9 then 1 else 0 end as num9,
		case when round(sum(fworktime)/60/60)&gt;#{minnum}+#{avgnum}*9 and round(sum(fworktime)/60/60)&lt;=#{minnum}+10+#{avgnum}*10 then 1 else 0 end as num10
		FROM tb_work l left join tb_welder w on l.fwelder_id = w.fwelder_no
		inner join tb_welded_junction j on l.fjunction_id = j.fwelded_junction_no
		inner join tb_insframework i on i.fid = l.fitemid
		inner join tb_insframework ins on ins.fid = i.fparent
		where 1=1  
		<if test="parent!=null and parent!=''">
			AND (i.fid = #{parent} or i.fparent=#{parent} or ins.fparent=#{parent}) 
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if>
		group by w.fname ORDER by round(sum(fworktime)/60/60))A)temp
	</select>
	
	<!-- 	查询实时数据集团焊机数量 -->
	<select id="getBlocMachineCount" resultMap="dtoMap">
		SELECT COUNT(distinct(fmachine_id)) loads,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldTime,ins.fparent fid FROM 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoStatus>0">
				tb_work
			</if>
			<if test="dto.dtoStatus==0">
				tb_standby
			</if>
		</if> l 
		INNER JOIN tb_insframework i on i.fid = l.fitemid  INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE 1=1
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if> group by weldTime,ins.fparent
	</select>
	
	<!-- 	查询实时数据公司焊机数量 -->
	<select id="getCompanyMachineCount" resultMap="dtoMap">
		SELECT COUNT(distinct(fmachine_id)) loads,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldTime,ins.fid FROM 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoStatus>0">
				tb_work
			</if>
			<if test="dto.dtoStatus==0">
				tb_standby
			</if>
		</if> l 
		INNER JOIN tb_insframework i on i.fid = l.fitemid  INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
		WHERE  1=1
		<if test="parent!=null and parent!=''">
			AND ins.fparent = #{parent}
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if> group by weldTime,ins.fid
	</select>

	<!-- 	查询实时数据事业部/项目部焊机数量 -->
	<select id="getCaustMachineCount" resultMap="dtoMap">
		SELECT COUNT(distinct(fmachine_id)) loads,
		<if test="dto!=null and dto!=''">
			<if test="dto.year!=null and dto.year!=''">
				DATE_FORMAT( fstarttime,  '%Y' )
			</if>
			<if test="dto.month!=null and dto.month!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m' )
			</if>
			<if test="dto.day!=null and dto.day!=''">
				DATE_FORMAT( fstarttime,  '%Y-%m-%d' )
			</if>
			<if test="dto.week!=null and dto.week!=''">
				weekofyear(fstarttime)
			</if>
		</if> weldTime,i.fid FROM 
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoStatus>0">
				tb_work
			</if>
			<if test="dto.dtoStatus==0">
				tb_standby
			</if>
		</if> l 
		INNER JOIN tb_insframework i on i.fid = l.fitemid
		INNER JOIN tb_insframework ins ON ins.fid = i.fparent
		WHERE 1=1
		<if test="parent!=null and parent!=''">
			AND (i.fid = #{parent} or ins.fid = #{parent} or ins.fparent=#{parent})
		</if>
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
		</if> group by weldTime,i.fid
	</select>
	
	<!-- 	根据组织机构及时间点获取工作总时长 -->
	<select id="getCountByTime" resultType="java.math.BigInteger">
		select sum(time) from (
		select sum(fworktime) time from tb_work l 
		INNER JOIN tb_insframework i on i.fid = l.fitemid 
		INNER JOIN tb_insframework ins on ins.fid = i.fparent 
		where fstarttime &gt;= #{time} and fendtime &lt; date_sub(date_sub(#{time},interval -1 day),interval 0 minute)
		<if test="parent!=null and parent!=''">
			and (i.fid=#{parent} or ins.fid=#{parent} or ins.fparent=#{parent})
		</if>
		<if test="mid!=null and mid!=''">
			and fmachine_id = #{mid}
		</if>
     	UNION ALL
     	select sum(fstandbytime) time from tb_standby l 
		INNER JOIN tb_insframework i on i.fid = l.fitemid 
		INNER JOIN tb_insframework ins on ins.fid = i.fparent 
		where fstarttime &gt;= #{time} and fendtime &lt; date_sub(date_sub(#{time},interval -1 day),interval 0 minute)
		<if test="parent!=null and parent!=''">
			and (i.fid=#{parent} or ins.fid=#{parent} or ins.fparent=#{parent})
		</if>
		<if test="mid!=null and mid!=''">
			and fmachine_id = #{mid}
		</if>
		)temp
	</select>
	
	<!-- 获取焊机使用时间排行之最top10 -->
	<select id="getWeldingmachineList" resultMap="dtoMap">
		select sum(fworktime)/60/60 loads,fequipment_no fname from tb_work l LEFT JOIN tb_welding_machine m on m.fid = l.fmachine_id 
		INNER join tb_insframework i on i.fid = l.fitemid INNER join tb_insframework ins on ins.fid = i.fparent WHERE 1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.parent!=null and dto.parent!=''">
				AND (ins.fparent = #{dto.parent} or ins.fid=#{dto.parent} or i.fid=#{dto.parent})
			</if>
		</if>
		 group by fmachine_id ORDER by loads
		 <if test="dto!=null and dto!=''">
			<if test="dto.dtoStatus!=0">
		 		DESC
			</if>
		</if>
		LIMIT 10
	</select>
	
	
	<!-- 获取焊工工作时间排行之最top10 -->
	<select id="getWelderList" resultMap="dtoMap">
		select sum(fworktime) /60/60 loads,w.fname FROM  tb_work l  left JOIN  tb_welder w on w.fwelder_no = l.fwelder_id 
		INNER join tb_insframework i on i.fid = l.fitemid INNER join tb_insframework ins on ins.fid = i.fparent WHERE 1=1
		<if test="dto!=null and dto!=''">
			<if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
				and fstarttime &gt;= #{dto.dtoTime1}
			</if>
			<if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
				and fendtime &lt;= #{dto.dtoTime2}
			</if>
			<if test="dto.parent!=null and dto.parent!=''">
				AND (ins.fparent = #{dto.parent} or ins.fid=#{dto.parent} or i.fid=#{dto.parent})
			</if>
		</if>
		group by w.fname ORDER by loads 
		 <if test="dto!=null and dto!=''">
			<if test="dto.dtoStatus!=0">
		 		DESC
			</if>
		</if>
		LIMIT 10
	</select>

</mapper>
