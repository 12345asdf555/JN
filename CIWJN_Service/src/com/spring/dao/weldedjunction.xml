<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.dao.WeldedJunctionMapper">

	<resultMap id="wjMap" type="com.spring.model.WeldedJunction">
        <id property="id" column="fid"></id> 
        <result property="weldedJunctionno" column="fwelded_junction_no"></result>  
        <result property="serialNo" column="fserial_no"></result>
        <result property="pipelineNo" column="fpipeline_no"></result>
        <result property="roomNo" column="froom_no"></result>
        <result property="unit" column="funit"></result>
        <result property="area" column="farea"></result>
        <result property="systems" column="fsystems"></result>
        <result property="children" column="fchildren"></result>
        <result property="externalDiameter" column="fexternal_diameter"></result>
        <result property="wallThickness" column="fwall_thickness"></result>
        <result property="dyne" column="fdyne"></result>
        <result property="specification" column="fspecification"></result>
        <result property="maxElectricity" column="fmax_electricity"></result>
        <result property="minElectricity" column="fmin_electricity"></result>
        <result property="maxValtage" column="fmax_valtage"></result>
        <result property="minValtage" column="fmin_valtage"></result>
        <result property="startTime" column="fstart_time"></result>
        <result property="endTime" column="fend_time"></result>
        <result property="material" column="fmaterial"></result>
        <result property="nextexternaldiameter" column="fnextExternal_diameter"></result>
        <result property="nextwall_thickness" column="fnextwall_thickness"></result>
        <result property="next_material" column="fnext_material"></result>
        <result property="creatTime" column="fcreatetime"></result>
        <result property="updateTime" column="fupdatetime"></result>
        <result property="updatecount" column="fupdatecount"></result>
        <result property="valtage_unit" column="fvaltage_unit"></result>
        <result property="electricity_unit" column="felectricity_unit"></result>
		<result property="creator" column="fcreator" />
		<result property="modifier" column="fmodifier" />
		<result property="taskid" column="ftaskid" />
		<result property="welderid" column="fwelderid" />
		<result property="machineid" column="fmachineid" />
		<result property="operatorid" column="foperatorr" />
        <association property="itemid" column="fitemId" javaType="com.spring.model.Insframework">  
            <id property="id" column="iid"></id> 
            <result property="name" column="iname"></result>  
            <result property="logogram" column="flogogram"></result>  
            <result property="code" column="fcode"></result>
        	<result property="parent" column="fparent"></result>
        	<result property="type" column="ftype"></result>
        </association>
	</resultMap>
	
	<select id="getWeldedJunctionAll" resultMap="wjMap">
		SELECT r.fid,r.ftaskid,j.fwelded_junction_no,j.fserial_no,r.fwelderid,w.fwelder_no fpipeline_no,w.fname froom_no,r.fmachineid,m.fequipment_no funit,j.fitemId iid,i.fname iname,r.foperatetype fdyne,j.fstart_time,j.fend_time FROM tb_welded_junction j
		LEFT JOIN tb_taskresult r ON r.ftaskid=j.fid
		INNER JOIN tb_insframework i ON j.fitemId=i.fid
		LEFT JOIN tb_welder w ON r.fwelderid=w.fid
		LEFT JOIN tb_welding_machine m ON r.fmachineid=m.fid
		WHERE 1=1 ORDER BY r.fid
	</select>
	
	<select id="getWeldedJunctionById" resultMap="wjMap" parameterType="java.lang.String">
		SELECT j. * , i.fid iid, i.fname iname FROM tb_welded_junction j INNER JOIN tb_insframework i ON j.fitemId = i.fid WHERE j.fid = #{id}
	</select>
	
	<select id="getWeldedjunctionByNo" resultType="java.lang.Integer" parameterType="java.lang.String">
		SELECT COUNT(fid) FROM `tb_welded_junction` WHERE fwelded_junction_no = #{wjno}
	</select>
	
	<insert id="addJunction" parameterType="com.spring.model.WeldedJunction" useGeneratedKeys="true" keyProperty="id">
		insert into tb_welded_junction(fwelded_junction_no,fserial_no,fdyne,fexternal_diameter,fitemId,fstart_time,fend_time) 
		values(#{weldedJunctionno},#{serialNo},#{dyne},#{itemid.id},#{externalDiameter},#{startTime},#{endTime});
	</insert>
	
	<update id="updateJunction" parameterType="com.spring.model.WeldedJunction">
		update tb_welded_junction set fwelded_junction_no=#{weldedJunctionno},fserial_no=#{serialNo},fdyne=#{dyne},
		fitemId=#{itemid.id} where fid=#{id},fstart_time=#{startTime},fend_time=#{endTime},fexternal_diameter=#{externalDiameter};
	</update>
	
	<delete id="deleteJunction" parameterType="java.math.BigInteger">
		delete from tb_welded_junction where fid=#{id}
	</delete>
	
	<select id="getTaskResultAll" resultMap="wjMap" parameterType="java.lang.String">
		SELECT j. * , i.fid iid, i.fname iname FROM tb_welded_junction j INNER JOIN tb_insframework i ON j.fitemId = i.fid WHERE 1 =1
		<if test="str!=null and str!=''">
			and ${str}
		</if>
	</select>
	
	<insert id="addTaskResult" parameterType="com.spring.model.WeldedJunction" useGeneratedKeys="true" keyProperty="id">
		insert into tb_taskresult(ftaskid,fwelderid,fmachineid,foperatedate,foperatetype,foperator,fresult,fresultid) 
		values(#{taskid},#{welderid},#{machineid},now(),#{dyne},#{operatorid},#{area},#{updatecount});
	</insert>
	
	<update id="updateTaskResult" parameterType="com.spring.model.WeldedJunction">
		update tb_taskresult set ftaskid=#{taskid},fwelderid=#{welderid},fmachineid=#{machineid},foperatedate=now(),foperatetype=#{dyne},foperator=#{operatorid},fresult=#{area},fresultid=#{updatecount} where fid=#{id};
	</update>
	
	<delete id="deleteTaskResult" parameterType="java.math.BigInteger">
		delete from tb_taskresult where fid=#{id}
	</delete>
</mapper>
